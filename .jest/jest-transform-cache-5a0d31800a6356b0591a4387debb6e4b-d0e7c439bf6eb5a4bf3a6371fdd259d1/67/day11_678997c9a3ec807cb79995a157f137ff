2d6b135889809e7e12ebd53c755bd9fd
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.part1 = part1;
exports.part2 = part2;

var _jsCombinatorics = _interopRequireDefault(require("js-combinatorics"));

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function parse(input) {
  let pieces = [];
  const state = {
    elevator: 0,
    floors: input.split('\n').map(x => {
      const generators = x.match(/[^\s]+(?=\s*generator)/g) || [];
      const microchips = x.match(/[^\s]+(?=-compatible microchip)/g) || [];
      pieces = pieces.concat(generators).concat(microchips);
      return {
        generators,
        microchips
      };
    })
  };
  state.pieces = pieces;
  return state;
}

function select(arr, num) {
  let selected = [];

  for (num = Math.min(num, arr.length); num > 0; num--) {
    selected = selected.concat(_jsCombinatorics.default.combination(arr, num).toArray());
  }

  return selected;
}

function applyMove({
  elevator,
  floors,
  pieces
}, diff, move) {
  return {
    elevator: elevator + diff,
    pieces,
    floors: floors.map((floor, i) => {
      if (i === elevator) {
        return {
          generators: floor.generators.filter(x => !move.generators.includes(x)),
          microchips: floor.microchips.filter(x => !move.microchips.includes(x))
        };
      } else if (i === elevator + diff) {
        return {
          generators: floor.generators.concat(move.generators),
          microchips: floor.microchips.concat(move.microchips)
        };
      } else {
        return floor;
      }
    })
  };
}

function legal(state) {
  return state.floors.every(floor => {
    return floor.generators.length === 0 || floor.microchips.every(m => floor.generators.includes(m));
  });
}

function getMoves(state, diff) {
  const src = state.floors[state.elevator];
  const pairs = src.generators.filter(x => src.microchips.includes(x));
  return pairs.map(x => ({
    generators: [x],
    microchips: [x]
  })).concat(select(src.microchips, 2).map(x => ({
    microchips: x,
    generators: []
  }))).concat(select(src.generators, 2).map(x => ({
    generators: x,
    microchips: []
  }))).map(move => applyMove(state, diff, move)).filter(legal);
}

function score({
  state,
  distance
}) {
  return distance + state.floors.reduce((sum, x, i) => sum + 2 * (state.floors.length - i - 1) * (x.generators.length + x.microchips.length), 0);
}

function getNeighbors(state) {
  let neighbors = [];

  if (state.elevator < state.floors.length - 1) {
    neighbors = neighbors.concat(getMoves(state, 1));
  }

  if (state.elevator > 0 && state.floors.some((x, i) => i < state.elevator && x.generators.length + x.microchips.length > 0)) {
    neighbors = neighbors.concat(getMoves(state, -1));
  }

  return neighbors;
}

function done(state) {
  const {
    generators,
    microchips
  } = state.floors[state.floors.length - 1];
  return state.pieces.length === generators.length + microchips.length;
} // function print(state) {
//   const dic = {
//     promethium: 'P',
//     cobalt: 'T',
//     curium: 'C',
//     ruthenium: 'R',
//     plutonium: 'L',
//     elerium: 'E',
//     dilithium: 'D',
//     hydrogen: 'H',
//     lithium: 'M'
//   };
//   const str = state.floors.map((floor, i) => {
//     let str = `${i} `;
//     str += i === state.elevator ? 'E ' : '  ';
//     Object.keys(dic).filter(x => state.pieces.includes(x)).forEach(k => {
//       str += floor.generators.includes(k) ? `${dic[k]}G ` : '   ';
//       str += floor.microchips.includes(k) ? `${dic[k]}M ` : '   ';
//     });
//     return str;
//   }).reverse().join('\n');
//   return str;
// }


function stringify({
  elevator,
  floors
}) {
  return JSON.stringify({
    elevator,
    floors: floors.map((floor, i) => {
      return {
        generators: floor.generators.map(x => i - floors.findIndex(f => f.microchips.includes(x))).sort(),
        microchips: floor.microchips.map(x => i - floors.findIndex(f => f.generators.includes(x))).sort()
      };
    })
  });
}

function solve(state) {
  const queue = [{
    distance: 0,
    state,
    path: [state]
  }];
  const visited = new Set().add(stringify(state));

  while (queue.length > 0) {
    const {
      state,
      distance,
      path
    } = queue.shift();
    const neighbors = getNeighbors(state).filter(x => !visited.has(stringify(x)));

    for (const x of neighbors) {
      const json = stringify(x);

      if (done(x)) {
        // path.concat(x).forEach(state => console.log(print(state), '\n----------------------'));
        return distance + 1;
      } else if (!visited.has(json)) {
        visited.add(json);
        queue.push({
          distance: distance + 1,
          state: x,
          path: path.concat(x)
        });
      }
    }

    queue.sort((a, b) => score(a) - score(b));
  }
}

function part1(input) {
  return solve(parse(input));
}

function part2(input) {
  const state = parse(input);
  state.floors[0].generators.push('elerium', 'dilithium');
  state.floors[0].microchips.push('elerium', 'dilithium');
  state.pieces.push('elerium', 'dilithium', 'elerium', 'dilithium');
  return solve(state);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRheTExLmpzIl0sIm5hbWVzIjpbInBhcnNlIiwiaW5wdXQiLCJwaWVjZXMiLCJzdGF0ZSIsImVsZXZhdG9yIiwiZmxvb3JzIiwic3BsaXQiLCJtYXAiLCJ4IiwiZ2VuZXJhdG9ycyIsIm1hdGNoIiwibWljcm9jaGlwcyIsImNvbmNhdCIsInNlbGVjdCIsImFyciIsIm51bSIsInNlbGVjdGVkIiwiTWF0aCIsIm1pbiIsImxlbmd0aCIsIkNvbWJpbmF0b3JpY3MiLCJjb21iaW5hdGlvbiIsInRvQXJyYXkiLCJhcHBseU1vdmUiLCJkaWZmIiwibW92ZSIsImZsb29yIiwiaSIsImZpbHRlciIsImluY2x1ZGVzIiwibGVnYWwiLCJldmVyeSIsIm0iLCJnZXRNb3ZlcyIsInNyYyIsInBhaXJzIiwic2NvcmUiLCJkaXN0YW5jZSIsInJlZHVjZSIsInN1bSIsImdldE5laWdoYm9ycyIsIm5laWdoYm9ycyIsInNvbWUiLCJkb25lIiwic3RyaW5naWZ5IiwiSlNPTiIsImZpbmRJbmRleCIsImYiLCJzb3J0Iiwic29sdmUiLCJxdWV1ZSIsInBhdGgiLCJ2aXNpdGVkIiwiU2V0IiwiYWRkIiwic2hpZnQiLCJoYXMiLCJqc29uIiwicHVzaCIsImEiLCJiIiwicGFydDEiLCJwYXJ0MiJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQTs7OztBQUVBLFNBQVNBLEtBQVQsQ0FBZUMsS0FBZixFQUFzQjtBQUNwQixNQUFJQyxNQUFNLEdBQUcsRUFBYjtBQUNBLFFBQU1DLEtBQUssR0FBRztBQUNaQyxJQUFBQSxRQUFRLEVBQUUsQ0FERTtBQUVaQyxJQUFBQSxNQUFNLEVBQUVKLEtBQUssQ0FBQ0ssS0FBTixDQUFZLElBQVosRUFBa0JDLEdBQWxCLENBQXNCQyxDQUFDLElBQUk7QUFDakMsWUFBTUMsVUFBVSxHQUFHRCxDQUFDLENBQUNFLEtBQUYsQ0FBUSx5QkFBUixLQUFzQyxFQUF6RDtBQUNBLFlBQU1DLFVBQVUsR0FBR0gsQ0FBQyxDQUFDRSxLQUFGLENBQVEsa0NBQVIsS0FB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SUFBQUEsS0FBSyxDQUFDRixJQUFOLENBQVcsQ0FBQ1csQ0FBRCxFQUFJQyxDQUFKLEtBQVV4QixLQUFLLENBQUN1QixDQUFELENBQUwsR0FBV3ZCLEtBQUssQ0FBQ3dCLENBQUQsQ0FBckM7QUFDRDtBQUNGOztBQUVNLFNBQVNDLEtBQVQsQ0FBZTVELEtBQWYsRUFBc0I7QUFDM0IsU0FBT2dELEtBQUssQ0FBQ2pELEtBQUssQ0FBQ0MsS0FBRCxDQUFOLENBQVo7QUFDRDs7QUFFTSxTQUFTNkQsS0FBVCxDQUFlN0QsS0FBZixFQUFzQjtBQUMzQixRQUFNRSxLQUFLLEdBQUdILEtBQUssQ0FBQ0MsS0FBRCxDQUFuQjtBQUNBRSxFQUFBQSxLQUFLLENBQUNFLE1BQU4sQ0FBYSxDQUFiLEVBQWdCSSxVQUFoQixDQUEyQmlELElBQTNCLENBQWdDLFNBQWhDLEVBQTJDLFdBQTNDO0FBQ0F2RCxFQUFBQSxLQUFLLENBQUNFLE1BQU4sQ0FBYSxDQUFiLEVBQWdCTSxVQUFoQixDQUEyQitDLElBQTNCLENBQWdDLFNBQWhDLEVBQTJDLFdBQTNDO0FBQ0F2RCxFQUFBQSxLQUFLLENBQUNELE1BQU4sQ0FBYXdELElBQWIsQ0FBa0IsU0FBbEIsRUFBNkIsV0FBN0IsRUFBMEMsU0FBMUMsRUFBcUQsV0FBckQ7QUFDQSxTQUFPVCxLQUFLLENBQUM5QyxLQUFELENBQVo7QUFDRCIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBDb21iaW5hdG9yaWNzIGZyb20gJ2pzLWNvbWJpbmF0b3JpY3MnO1xuXG5mdW5jdGlvbiBwYXJzZShpbnB1dCkge1xuICBsZXQgcGllY2VzID0gW107XG4gIGNvbnN0IHN0YXRlID0ge1xuICAgIGVsZXZhdG9yOiAwLFxuICAgIGZsb29yczogaW5wdXQuc3BsaXQoJ1xcbicpLm1hcCh4ID0+IHtcbiAgICAgIGNvbnN0IGdlbmVyYXRvcnMgPSB4Lm1hdGNoKC9bXlxcc10rKD89XFxzKmdlbmVyYXRvcikvZykgfHwgW107XG4gICAgICBjb25zdCBtaWNyb2NoaXBzID0geC5tYXRjaCgvW15cXHNdKyg/PS1jb21wYXRpYmxlIG1pY3JvY2hpcCkvZykgfHwgW107XG4gICAgICBwaWVjZXMgPSBwaWVjZXMuY29uY2F0KGdlbmVyYXRvcnMpLmNvbmNhdChtaWNyb2NoaXBzKTtcbiAgICAgIHJldHVybiB7IGdlbmVyYXRvcnMsIG1pY3JvY2hpcHMgfTtcbiAgICB9KSxcbiAgfTtcbiAgc3RhdGUucGllY2VzID0gcGllY2VzO1xuICByZXR1cm4gc3RhdGU7XG59XG5cbmZ1bmN0aW9uIHNlbGVjdChhcnIsIG51bSkge1xuICBsZXQgc2VsZWN0ZWQgPSBbXTtcbiAgZm9yIChudW0gPSBNYXRoLm1pbihudW0sIGFyci5sZW5ndGgpOyBudW0gPiAwOyBudW0tLSkge1xuICAgIHNlbGVjdGVkID0gc2VsZWN0ZWQuY29uY2F0KENvbWJpbmF0b3JpY3MuY29tYmluYXRpb24oYXJyLCBudW0pLnRvQXJyYXkoKSk7XG4gIH1cbiAgcmV0dXJuIHNlbGVjdGVkO1xufVxuXG5mdW5jdGlvbiBhcHBseU1vdmUoeyBlbGV2YXRvciwgZmxvb3JzLCBwaWVjZXMgfSwgZGlmZiwgbW92ZSkge1xuICByZXR1cm4ge1xuICAgIGVsZXZhdG9yOiBlbGV2YXRvciArIGRpZmYsXG4gICAgcGllY2VzLFxuICAgIGZsb29yczogZmxvb3JzLm1hcCgoZmxvb3IsIGkpID0+IHtcbiAgICAgIGlmIChpID09PSBlbGV2YXRvcikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIGdlbmVyYXRvcnM6IGZsb29yLmdlbmVyYXRvcnMuZmlsdGVyKFxuICAgICAgICAgICAgeCA9PiAhbW92ZS5nZW5lcmF0b3JzLmluY2x1ZGVzKHgpLFxuICAgICAgICAgICksXG4gICAgICAgICAgbWljcm9jaGlwczogZmxvb3IubWljcm9jaGlwcy5maWx0ZXIoXG4gICAgICAgICAgICB4ID0+ICFtb3ZlLm1pY3JvY2hpcHMuaW5jbHVkZXMoeCksXG4gICAgICAgICAgKSxcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSBpZiAoaSA9PT0gZWxldmF0b3IgKyBkaWZmKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgZ2VuZXJhdG9yczogZmxvb3IuZ2VuZXJhdG9ycy5jb25jYXQobW92ZS5nZW5lcmF0b3JzKSxcbiAgICAgICAgICBtaWNyb2NoaXBzOiBmbG9vci5taWNyb2NoaXBzLmNvbmNhdChtb3ZlLm1pY3JvY2hpcHMpLFxuICAgICAgICB9O1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmV0dXJuIGZsb29yO1xuICAgICAgfVxuICAgIH0pLFxuICB9O1xufVxuXG5mdW5jdGlvbiBsZWdhbChzdGF0ZSkge1xuICByZXR1cm4gc3RhdGUuZmxvb3JzLmV2ZXJ5KGZsb29yID0+IHtcbiAgICByZXR1cm4gKFxuICAgICAgZmxvb3IuZ2VuZXJhdG9ycy5sZW5ndGggPT09IDAgfHxcbiAgICAgIGZsb29yLm1pY3JvY2hpcHMuZXZlcnkobSA9PiBmbG9vci5nZW5lcmF0b3JzLmluY2x1ZGVzKG0pKVxuICAgICk7XG4gIH0pO1xufVxuXG5mdW5jdGlvbiBnZXRNb3ZlcyhzdGF0ZSwgZGlmZikge1xuICBjb25zdCBzcmMgPSBzdGF0ZS5mbG9vcnNbc3RhdGUuZWxldmF0b3JdO1xuICBjb25zdCBwYWlycyA9IHNyYy5nZW5lcmF0b3JzLmZpbHRlcih4ID0+IHNyYy5taWNyb2NoaXBzLmluY2x1ZGVzKHgpKTtcbiAgcmV0dXJuIHBhaXJzXG4gICAgLm1hcCh4ID0+ICh7IGdlbmVyYXRvcnM6IFt4XSwgbWljcm9jaGlwczogW3hdIH0pKVxuICAgIC5jb25jYXQoXG4gICAgICBzZWxlY3Qoc3JjLm1pY3JvY2hpcHMsIDIpLm1hcCh4ID0+ICh7IG1pY3JvY2hpcHM6IHgsIGdlbmVyYXRvcnM6IFtdIH0pKSxcbiAgICApXG4gICAgLmNvbmNhdChcbiAgICAgIHNlbGVjdChzcmMuZ2VuZXJhdG9ycywgMikubWFwKHggPT4gKHsgZ2VuZXJhdG9yczogeCwgbWljcm9jaGlwczogW10gfSkpLFxuICAgIClcbiAgICAubWFwKG1vdmUgPT4gYXBwbHlNb3ZlKHN0YXRlLCBkaWZmLCBtb3ZlKSlcbiAgICAuZmlsdGVyKGxlZ2FsKTtcbn1cblxuZnVuY3Rpb24gc2NvcmUoeyBzdGF0ZSwgZGlzdGFuY2UgfSkge1xuICByZXR1cm4gKFxuICAgIGRpc3RhbmNlICtcbiAgICBzdGF0ZS5mbG9vcnMucmVkdWNlKFxuICAgICAgKHN1bSwgeCwgaSkgPT5cbiAgICAgICAgc3VtICtcbiAgICAgICAgMiAqXG4gICAgICAgICAgKHN0YXRlLmZsb29ycy5sZW5ndGggLSBpIC0gMSkgKlxuICAgICAgICAgICh4LmdlbmVyYXRvcnMubGVuZ3RoICsgeC5taWNyb2NoaXBzLmxlbmd0aCksXG4gICAgICAwLFxuICAgIClcbiAgKTtcbn1cblxuZnVuY3Rpb24gZ2V0TmVpZ2hib3JzKHN0YXRlKSB7XG4gIGxldCBuZWlnaGJvcnMgPSBbXTtcbiAgaWYgKHN0YXRlLmVsZXZhdG9yIDwgc3RhdGUuZmxvb3JzLmxlbmd0aCAtIDEpIHtcbiAgICBuZWlnaGJvcnMgPSBuZWlnaGJvcnMuY29uY2F0KGdldE1vdmVzKHN0YXRlLCAxKSk7XG4gIH1cbiAgaWYgKFxuICAgIHN0YXRlLmVsZXZhdG9yID4gMCAmJlxuICAgIHN0YXRlLmZsb29ycy5zb21lKFxuICAgICAgKHgsIGkpID0+XG4gICAgICAgIGkgPCBzdGF0ZS5lbGV2YXRvciAmJiB4LmdlbmVyYXRvcnMubGVuZ3RoICsgeC5taWNyb2NoaXBzLmxlbmd0aCA+IDAsXG4gICAgKVxuICApIHtcbiAgICBuZWlnaGJvcnMgPSBuZWlnaGJvcnMuY29uY2F0KGdldE1vdmVzKHN0YXRlLCAtMSkpO1xuICB9XG4gIHJldHVybiBuZWlnaGJvcnM7XG59XG5cbmZ1bmN0aW9uIGRvbmUoc3RhdGUpIHtcbiAgY29uc3QgeyBnZW5lcmF0b3JzLCBtaWNyb2NoaXBzIH0gPSBzdGF0ZS5mbG9vcnNbc3RhdGUuZmxvb3JzLmxlbmd0aCAtIDFdO1xuICByZXR1cm4gc3RhdGUucGllY2VzLmxlbmd0aCA9PT0gZ2VuZXJhdG9ycy5sZW5ndGggKyBtaWNyb2NoaXBzLmxlbmd0aDtcbn1cblxuLy8gZnVuY3Rpb24gcHJpbnQoc3RhdGUpIHtcbi8vICAgY29uc3QgZGljID0ge1xuLy8gICAgIHByb21ldGhpdW06ICdQJyxcbi8vICAgICBjb2JhbHQ6ICdUJyxcbi8vICAgICBjdXJpdW06ICdDJyxcbi8vICAgICBydXRoZW5pdW06ICdSJyxcbi8vICAgICBwbHV0b25pdW06ICdMJyxcbi8vICAgICBlbGVyaXVtOiAnRScsXG4vLyAgICAgZGlsaXRoaXVtOiAnRCcsXG4vLyAgICAgaHlkcm9nZW46ICdIJyxcbi8vICAgICBsaXRoaXVtOiAnTSdcbi8vICAgfTtcbi8vICAgY29uc3Qgc3RyID0gc3RhdGUuZmxvb3JzLm1hcCgoZmxvb3IsIGkpID0+IHtcbi8vICAgICBsZXQgc3RyID0gYCR7aX0gYDtcbi8vICAgICBzdHIgKz0gaSA9PT0gc3RhdGUuZWxldmF0b3IgPyAnRSAnIDogJyAgJztcbi8vICAgICBPYmplY3Qua2V5cyhkaWMpLmZpbHRlcih4ID0+IHN0YXRlLnBpZWNlcy5pbmNsdWRlcyh4KSkuZm9yRWFjaChrID0+IHtcbi8vICAgICAgIHN0ciArPSBmbG9vci5nZW5lcmF0b3JzLmluY2x1ZGVzKGspID8gYCR7ZGljW2tdfUcgYCA6ICcgICAnO1xuLy8gICAgICAgc3RyICs9IGZsb29yLm1pY3JvY2hpcHMuaW5jbHVkZXMoaykgPyBgJHtkaWNba119TSBgIDogJyAgICc7XG4vLyAgICAgfSk7XG4vLyAgICAgcmV0dXJuIHN0cjtcbi8vICAgfSkucmV2ZXJzZSgpLmpvaW4oJ1xcbicpO1xuLy8gICByZXR1cm4gc3RyO1xuLy8gfVxuXG5mdW5jdGlvbiBzdHJpbmdpZnkoeyBlbGV2YXRvciwgZmxvb3JzIH0pIHtcbiAgcmV0dXJuIEpTT04uc3RyaW5naWZ5KHtcbiAgICBlbGV2YXRvcixcbiAgICBmbG9vcnM6IGZsb29ycy5tYXAoKGZsb29yLCBpKSA9PiB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBnZW5lcmF0b3JzOiBmbG9vci5nZW5lcmF0b3JzXG4gICAgICAgICAgLm1hcCh4ID0+IGkgLSBmbG9vcnMuZmluZEluZGV4KGYgPT4gZi5taWNyb2NoaXBzLmluY2x1ZGVzKHgpKSlcbiAgICAgICAgICAuc29ydCgpLFxuICAgICAgICBtaWNyb2NoaXBzOiBmbG9vci5taWNyb2NoaXBzXG4gICAgICAgICAgLm1hcCh4ID0+IGkgLSBmbG9vcnMuZmluZEluZGV4KGYgPT4gZi5nZW5lcmF0b3JzLmluY2x1ZGVzKHgpKSlcbiAgICAgICAgICAuc29ydCgpLFxuICAgICAgfTtcbiAgICB9KSxcbiAgfSk7XG59XG5cbmZ1bmN0aW9uIHNvbHZlKHN0YXRlKSB7XG4gIGNvbnN0IHF1ZXVlID0gW3sgZGlzdGFuY2U6IDAsIHN0YXRlLCBwYXRoOiBbc3RhdGVdIH1dO1xuICBjb25zdCB2aXNpdGVkID0gbmV3IFNldCgpLmFkZChzdHJpbmdpZnkoc3RhdGUpKTtcbiAgd2hpbGUgKHF1ZXVlLmxlbmd0aCA+IDApIHtcbiAgICBjb25zdCB7IHN0YXRlLCBkaXN0YW5jZSwgcGF0aCB9ID0gcXVldWUuc2hpZnQoKTtcbiAgICBjb25zdCBuZWlnaGJvcnMgPSBnZXROZWlnaGJvcnMoc3RhdGUpLmZpbHRlcihcbiAgICAgIHggPT4gIXZpc2l0ZWQuaGFzKHN0cmluZ2lmeSh4KSksXG4gICAgKTtcbiAgICBmb3IgKGNvbnN0IHggb2YgbmVpZ2hib3JzKSB7XG4gICAgICBjb25zdCBqc29uID0gc3RyaW5naWZ5KHgpO1xuICAgICAgaWYgKGRvbmUoeCkpIHtcbiAgICAgICAgLy8gcGF0aC5jb25jYXQoeCkuZm9yRWFjaChzdGF0ZSA9PiBjb25zb2xlLmxvZyhwcmludChzdGF0ZSksICdcXG4tLS0tLS0tLS0tLS0tLS0tLS0tLS0tJykpO1xuICAgICAgICByZXR1cm4gZGlzdGFuY2UgKyAxO1xuICAgICAgfSBlbHNlIGlmICghdmlzaXRlZC5oYXMoanNvbikpIHtcbiAgICAgICAgdmlzaXRlZC5hZGQoanNvbik7XG4gICAgICAgIHF1ZXVlLnB1c2goeyBkaXN0YW5jZTogZGlzdGFuY2UgKyAxLCBzdGF0ZTogeCwgcGF0aDogcGF0aC5jb25jYXQoeCkgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIHF1ZXVlLnNvcnQoKGEsIGIpID0+IHNjb3JlKGEpIC0gc2NvcmUoYikpO1xuICB9XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJ0MShpbnB1dCkge1xuICByZXR1cm4gc29sdmUocGFyc2UoaW5wdXQpKTtcbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHBhcnQyKGlucHV0KSB7XG4gIGNvbnN0IHN0YXRlID0gcGFyc2UoaW5wdXQpO1xuICBzdGF0ZS5mbG9vcnNbMF0uZ2VuZXJhdG9ycy5wdXNoKCdlbGVyaXVtJywgJ2RpbGl0aGl1bScpO1xuICBzdGF0ZS5mbG9vcnNbMF0ubWljcm9jaGlwcy5wdXNoKCdlbGVyaXVtJywgJ2RpbGl0aGl1bScpO1xuICBzdGF0ZS5waWVjZXMucHVzaCgnZWxlcml1bScsICdkaWxpdGhpdW0nLCAnZWxlcml1bScsICdkaWxpdGhpdW0nKTtcbiAgcmV0dXJuIHNvbHZlKHN0YXRlKTtcbn1cbiJdfQ==