3a044c80d442e2fca57fad1bddc8b148
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.part1 = part1;
exports.part2 = part2;

function parse(input) {
  const groups = [];
  let army;
  input.split('\n').forEach(line => {
    if (line === 'Immune System:') {
      army = 'Immune System';
    } else if (line === 'Infection:') {
      army = 'Infection';
    } else if (line.length > 0) {
      const [, units, hit, properties, attack, type, initiative] = line.match(/^(\d+) units each with (\d+) hit points(?: \(([^)]+)\))? with an attack that does (\d+) ([^\s]+) damage at initiative (\d+)$/);
      const group = {
        army,
        units: parseInt(units),
        hit: parseInt(hit),
        immune: [],
        weak: [],
        attack: parseInt(attack),
        type,
        initiative: parseInt(initiative)
      };

      if (properties) {
        properties.split('; ').forEach(property => {
          const [type, kinds] = property.split(' to ');
          group[type].push(...kinds.split(', '));
        });
      }

      groups.push(group);
    }
  });
  return groups;
}

function effectiveSort(a, b) {
  return b.units * b.attack - a.units * a.attack || b.initiative - a.initiative;
}

function damage(attacking, defending) {
  if (defending.immune.includes(attacking.type)) {
    return 0;
  } else if (defending.weak.includes(attacking.type)) {
    return attacking.units * attacking.attack * 2;
  } else {
    return attacking.units * attacking.attack;
  }
}

function battle(groups) {
  while (groups.some(group => group.army !== groups[0].army)) {
    groups.sort(effectiveSort);
    const options = groups.slice(0);
    const fight = [];
    groups.forEach(attacking => {
      const selected = options.filter(option => option.army !== attacking.army).map(option => ({
        option,
        damage: damage(attacking, option)
      })).sort((a, b) => b.damage - a.damage || effectiveSort(a.option, b.option)).shift();

      if (selected && selected.damage > 0) {
        const defending = selected.option;
        options.splice(options.indexOf(defending), 1);
        fight.push({
          attacking,
          defending
        });
      }
    });
    fight.sort((a, b) => b.attacking.initiative - a.attacking.initiative);
    let totalKilled = 0;
    fight.forEach(({
      attacking,
      defending
    }) => {
      if (attacking.units > 0) {
        const killed = Math.floor(damage(attacking, defending) / defending.hit);
        defending.units -= killed;
        totalKilled += killed;

        if (defending.units <= 0) {
          groups.splice(groups.indexOf(defending), 1);
        }
      }
    });

    if (totalKilled === 0) {
      return undefined;
    }
  }

  return groups;
}

function part1(input) {
  const groups = parse(input);
  return battle(groups).reduce((sum, group) => sum + group.units, 0);
}

function attempt(input, i) {
  const groups = parse(input);
  const boost = groups.map(g => {
    if (g.army === 'Immune System') {
      g.attack += i;
    }

    return g;
  });
  const result = battle(boost);
  return result && result[0].army === 'Immune System' && result.reduce((sum, group) => sum + group.units, 0);
}

function binarySearch(cb) {
  let start = 0;
  let increment = Math.pow(2, 10);

  while (increment > 4) {
    while (!cb(start)) {
      start += increment;
    }

    start -= increment;
    increment /= 2;
  }

  const end = start + increment * 2;

  for (let i = start; i <= end; i++) {
    if (cb(i)) {
      return cb(i);
    }
  }
}

function part2(input) {
  return binarySearch(i => attempt(input, i));
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRheTI0LmpzIl0sIm5hbWVzIjpbInBhcnNlIiwiaW5wdXQiLCJncm91cHMiLCJhcm15Iiwic3BsaXQiLCJmb3JFYWNoIiwibGluZSIsImxlbmd0aCIsInVuaXRzIiwiaGl0IiwicHJvcGVydGllcyIsImF0dGFjayIsInR5cGUiLCJpbml0aWF0aXZlIiwibWF0Y2giLCJncm91cCIsInBhcnNlSW50IiwiaW1tdW5lIiwid2VhayIsInByb3BlcnR5Iiwia2luZHMiLCJwdXNoIiwiZWZmZWN0aXZlU29ydCIsImEiLCJiIiwiZGFtYWdlIiwiYXR0YWNraW5nIiwiZGVmZW5kaW5nIiwiaW5jbHVkZXMiLCJiYXR0bGUiLCJzb21lIiwic29ydCIsIm9wdGlvbnMiLCJzbGljZSIsImZpZ2h0Iiwic2VsZWN0ZWQiLCJmaWx0ZXIiLCJvcHRpb24iLCJtYXAiLCJzaGlmdCIsInNwbGljZSIsImluZGV4T2YiLCJ0b3RhbEtpbGxlZCIsImtpbGxlZCIsIk1hdGgiLCJmbG9vciIsInVuZGVmaW5lZCIsInBhcnQxIiwicmVkdWNlIiwic3VtIiwiYXR0ZW1wdCIsImkiLCJib29zdCIsImciLCJyZXN1bHQiLCJiaW5hcnlTZWFyY2giLCJjYiIsInN0YXJ0IiwiaW5jcmVtZW50IiwicG93IiwiZW5kIiwicGFydDIiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7O0FBQUEsU0FBU0EsS0FBVCxDQUFlQyxLQUFmLEVBQXNCO0FBQ3BCLFFBQU1DLE1BQU0sR0FBRyxFQUFmO0FBQ0EsTUFBSUMsSUFBSjtBQUNBRixFQUFBQSxLQUFLLENBQUNHLEtBQU4sQ0FBWSxJQUFaLEVBQWtCQyxPQUFsQixDQUEwQkMsSUFBSSxJQUFJO0FBQ2hDLFFBQUlBLElBQUksS0FBSyxnQkFBYixFQUErQjtBQUM3QkgsTUFBQUEsSUFBSSxHQUFHLGVBQVA7QUFDRCxLQUZELE1BRU8sSUFBSUcsSUFBSSxLQUFLLFlBQWIsRUFBMkI7QUFDaENILE1BQUFBLElBQUksR0FBRyxXQUFQO0FBQ0QsS0FGTSxNQUVBLElBQUlH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Q0FBVW5ELElBQVYsS0FBbUIsZUFEbkIsSUFFQW1ELE1BQU0sQ0FBQ04sTUFBUCxDQUFjLENBQUNDLEdBQUQsRUFBTWxDLEtBQU4sS0FBZ0JrQyxHQUFHLEdBQUdsQyxLQUFLLENBQUNQLEtBQTFDLEVBQWlELENBQWpELENBSEY7QUFLRDs7QUFFRCxTQUFTK0MsWUFBVCxDQUFzQkMsRUFBdEIsRUFBMEI7QUFDeEIsTUFBSUMsS0FBSyxHQUFHLENBQVo7QUFDQSxNQUFJQyxTQUFTLEdBQUdkLElBQUksQ0FBQ2UsR0FBTCxDQUFTLENBQVQsRUFBWSxFQUFaLENBQWhCOztBQUNBLFNBQU9ELFNBQVMsR0FBRyxDQUFuQixFQUFzQjtBQUNwQixXQUFPLENBQUNGLEVBQUUsQ0FBQ0MsS0FBRCxDQUFWLEVBQW1CO0FBQ2pCQSxNQUFBQSxLQUFLLElBQUlDLFNBQVQ7QUFDRDs7QUFDREQsSUFBQUEsS0FBSyxJQUFJQyxTQUFUO0FBQ0FBLElBQUFBLFNBQVMsSUFBSSxDQUFiO0FBQ0Q7O0FBQ0QsUUFBTUUsR0FBRyxHQUFHSCxLQUFLLEdBQUdDLFNBQVMsR0FBRyxDQUFoQzs7QUFDQSxPQUFLLElBQUlQLENBQUMsR0FBR00sS0FBYixFQUFvQk4sQ0FBQyxJQUFJUyxHQUF6QixFQUE4QlQsQ0FBQyxFQUEvQixFQUFtQztBQUNqQyxRQUFJSyxFQUFFLENBQUNMLENBQUQsQ0FBTixFQUFXO0FBQ1QsYUFBT0ssRUFBRSxDQUFDTCxDQUFELENBQVQ7QUFDRDtBQUNGO0FBQ0Y7O0FBRU0sU0FBU1UsS0FBVCxDQUFlNUQsS0FBZixFQUFzQjtBQUMzQixTQUFPc0QsWUFBWSxDQUFDSixDQUFDLElBQUlELE9BQU8sQ0FBQ2pELEtBQUQsRUFBUWtELENBQVIsQ0FBYixDQUFuQjtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiZnVuY3Rpb24gcGFyc2UoaW5wdXQpIHtcbiAgY29uc3QgZ3JvdXBzID0gW107XG4gIGxldCBhcm15O1xuICBpbnB1dC5zcGxpdCgnXFxuJykuZm9yRWFjaChsaW5lID0+IHtcbiAgICBpZiAobGluZSA9PT0gJ0ltbXVuZSBTeXN0ZW06Jykge1xuICAgICAgYXJteSA9ICdJbW11bmUgU3lzdGVtJztcbiAgICB9IGVsc2UgaWYgKGxpbmUgPT09ICdJbmZlY3Rpb246Jykge1xuICAgICAgYXJteSA9ICdJbmZlY3Rpb24nO1xuICAgIH0gZWxzZSBpZiAobGluZS5sZW5ndGggPiAwKSB7XG4gICAgICBjb25zdCBbLCB1bml0cywgaGl0LCBwcm9wZXJ0aWVzLCBhdHRhY2ssIHR5cGUsIGluaXRpYXRpdmVdID0gbGluZS5tYXRjaChcbiAgICAgICAgL14oXFxkKykgdW5pdHMgZWFjaCB3aXRoIChcXGQrKSBoaXQgcG9pbnRzKD86IFxcKChbXildKylcXCkpPyB3aXRoIGFuIGF0dGFjayB0aGF0IGRvZXMgKFxcZCspIChbXlxcc10rKSBkYW1hZ2UgYXQgaW5pdGlhdGl2ZSAoXFxkKykkLyxcbiAgICAgICk7XG4gICAgICBjb25zdCBncm91cCA9IHtcbiAgICAgICAgYXJteSxcbiAgICAgICAgdW5pdHM6IHBhcnNlSW50KHVuaXRzKSxcbiAgICAgICAgaGl0OiBwYXJzZUludChoaXQpLFxuICAgICAgICBpbW11bmU6IFtdLFxuICAgICAgICB3ZWFrOiBbXSxcbiAgICAgICAgYXR0YWNrOiBwYXJzZUludChhdHRhY2spLFxuICAgICAgICB0eXBlLFxuICAgICAgICBpbml0aWF0aXZlOiBwYXJzZUludChpbml0aWF0aXZlKSxcbiAgICAgIH07XG4gICAgICBpZiAocHJvcGVydGllcykge1xuICAgICAgICBwcm9wZXJ0aWVzLnNwbGl0KCc7ICcpLmZvckVhY2gocHJvcGVydHkgPT4ge1xuICAgICAgICAgIGNvbnN0IFt0eXBlLCBraW5kc10gPSBwcm9wZXJ0eS5zcGxpdCgnIHRvICcpO1xuICAgICAgICAgIGdyb3VwW3R5cGVdLnB1c2goLi4ua2luZHMuc3BsaXQoJywgJykpO1xuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICAgIGdyb3Vwcy5wdXNoKGdyb3VwKTtcbiAgICB9XG4gIH0pO1xuICByZXR1cm4gZ3JvdXBzO1xufVxuXG5mdW5jdGlvbiBlZmZlY3RpdmVTb3J0KGEsIGIpIHtcbiAgcmV0dXJuIGIudW5pdHMgKiBiLmF0dGFjayAtIGEudW5pdHMgKiBhLmF0dGFjayB8fCBiLmluaXRpYXRpdmUgLSBhLmluaXRpYXRpdmU7XG59XG5cbmZ1bmN0aW9uIGRhbWFnZShhdHRhY2tpbmcsIGRlZmVuZGluZykge1xuICBpZiAoZGVmZW5kaW5nLmltbXVuZS5pbmNsdWRlcyhhdHRhY2tpbmcudHlwZSkpIHtcbiAgICByZXR1cm4gMDtcbiAgfSBlbHNlIGlmIChkZWZlbmRpbmcud2Vhay5pbmNsdWRlcyhhdHRhY2tpbmcudHlwZSkpIHtcbiAgICByZXR1cm4gYXR0YWNraW5nLnVuaXRzICogYXR0YWNraW5nLmF0dGFjayAqIDI7XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIGF0dGFja2luZy51bml0cyAqIGF0dGFja2luZy5hdHRhY2s7XG4gIH1cbn1cblxuZnVuY3Rpb24gYmF0dGxlKGdyb3Vwcykge1xuICB3aGlsZSAoZ3JvdXBzLnNvbWUoZ3JvdXAgPT4gZ3JvdXAuYXJteSAhPT0gZ3JvdXBzWzBdLmFybXkpKSB7XG4gICAgZ3JvdXBzLnNvcnQoZWZmZWN0aXZlU29ydCk7XG4gICAgY29uc3Qgb3B0aW9ucyA9IGdyb3Vwcy5zbGljZSgwKTtcbiAgICBjb25zdCBmaWdodCA9IFtdO1xuICAgIGdyb3Vwcy5mb3JFYWNoKGF0dGFja2luZyA9PiB7XG4gICAgICBjb25zdCBzZWxlY3RlZCA9IG9wdGlvbnNcbiAgICAgICAgLmZpbHRlcihvcHRpb24gPT4gb3B0aW9uLmFybXkgIT09IGF0dGFja2luZy5hcm15KVxuICAgICAgICAubWFwKG9wdGlvbiA9PiAoeyBvcHRpb24sIGRhbWFnZTogZGFtYWdlKGF0dGFja2luZywgb3B0aW9uKSB9KSlcbiAgICAgICAgLnNvcnQoXG4gICAgICAgICAgKGEsIGIpID0+IGIuZGFtYWdlIC0gYS5kYW1hZ2UgfHwgZWZmZWN0aXZlU29ydChhLm9wdGlvbiwgYi5vcHRpb24pLFxuICAgICAgICApXG4gICAgICAgIC5zaGlmdCgpO1xuICAgICAgaWYgKHNlbGVjdGVkICYmIHNlbGVjdGVkLmRhbWFnZSA+IDApIHtcbiAgICAgICAgY29uc3QgZGVmZW5kaW5nID0gc2VsZWN0ZWQub3B0aW9uO1xuICAgICAgICBvcHRpb25zLnNwbGljZShvcHRpb25zLmluZGV4T2YoZGVmZW5kaW5nKSwgMSk7XG4gICAgICAgIGZpZ2h0LnB1c2goeyBhdHRhY2tpbmcsIGRlZmVuZGluZyB9KTtcbiAgICAgIH1cbiAgICB9KTtcbiAgICBmaWdodC5zb3J0KChhLCBiKSA9PiBiLmF0dGFja2luZy5pbml0aWF0aXZlIC0gYS5hdHRhY2tpbmcuaW5pdGlhdGl2ZSk7XG4gICAgbGV0IHRvdGFsS2lsbGVkID0gMDtcbiAgICBmaWdodC5mb3JFYWNoKCh7IGF0dGFja2luZywgZGVmZW5kaW5nIH0pID0+IHtcbiAgICAgIGlmIChhdHRhY2tpbmcudW5pdHMgPiAwKSB7XG4gICAgICAgIGNvbnN0IGtpbGxlZCA9IE1hdGguZmxvb3IoZGFtYWdlKGF0dGFja2luZywgZGVmZW5kaW5nKSAvIGRlZmVuZGluZy5oaXQpO1xuICAgICAgICBkZWZlbmRpbmcudW5pdHMgLT0ga2lsbGVkO1xuICAgICAgICB0b3RhbEtpbGxlZCArPSBraWxsZWQ7XG4gICAgICAgIGlmIChkZWZlbmRpbmcudW5pdHMgPD0gMCkge1xuICAgICAgICAgIGdyb3Vwcy5zcGxpY2UoZ3JvdXBzLmluZGV4T2YoZGVmZW5kaW5nKSwgMSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcbiAgICBpZiAodG90YWxLaWxsZWQgPT09IDApIHtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuICB9XG4gIHJldHVybiBncm91cHM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJ0MShpbnB1dCkge1xuICBjb25zdCBncm91cHMgPSBwYXJzZShpbnB1dCk7XG4gIHJldHVybiBiYXR0bGUoZ3JvdXBzKS5yZWR1Y2UoKHN1bSwgZ3JvdXApID0+IHN1bSArIGdyb3VwLnVuaXRzLCAwKTtcbn1cblxuZnVuY3Rpb24gYXR0ZW1wdChpbnB1dCwgaSkge1xuICBjb25zdCBncm91cHMgPSBwYXJzZShpbnB1dCk7XG4gIGNvbnN0IGJvb3N0ID0gZ3JvdXBzLm1hcChnID0+IHtcbiAgICBpZiAoZy5hcm15ID09PSAnSW1tdW5lIFN5c3RlbScpIHtcbiAgICAgIGcuYXR0YWNrICs9IGk7XG4gICAgfVxuICAgIHJldHVybiBnO1xuICB9KTtcbiAgY29uc3QgcmVzdWx0ID0gYmF0dGxlKGJvb3N0KTtcbiAgcmV0dXJuIChcbiAgICByZXN1bHQgJiZcbiAgICByZXN1bHRbMF0uYXJteSA9PT0gJ0ltbXVuZSBTeXN0ZW0nICYmXG4gICAgcmVzdWx0LnJlZHVjZSgoc3VtLCBncm91cCkgPT4gc3VtICsgZ3JvdXAudW5pdHMsIDApXG4gICk7XG59XG5cbmZ1bmN0aW9uIGJpbmFyeVNlYXJjaChjYikge1xuICBsZXQgc3RhcnQgPSAwO1xuICBsZXQgaW5jcmVtZW50ID0gTWF0aC5wb3coMiwgMTApO1xuICB3aGlsZSAoaW5jcmVtZW50ID4gNCkge1xuICAgIHdoaWxlICghY2Ioc3RhcnQpKSB7XG4gICAgICBzdGFydCArPSBpbmNyZW1lbnQ7XG4gICAgfVxuICAgIHN0YXJ0IC09IGluY3JlbWVudDtcbiAgICBpbmNyZW1lbnQgLz0gMjtcbiAgfVxuICBjb25zdCBlbmQgPSBzdGFydCArIGluY3JlbWVudCAqIDI7XG4gIGZvciAobGV0IGkgPSBzdGFydDsgaSA8PSBlbmQ7IGkrKykge1xuICAgIGlmIChjYihpKSkge1xuICAgICAgcmV0dXJuIGNiKGkpO1xuICAgIH1cbiAgfVxufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFydDIoaW5wdXQpIHtcbiAgcmV0dXJuIGJpbmFyeVNlYXJjaChpID0+IGF0dGVtcHQoaW5wdXQsIGkpKTtcbn1cbiJdfQ==