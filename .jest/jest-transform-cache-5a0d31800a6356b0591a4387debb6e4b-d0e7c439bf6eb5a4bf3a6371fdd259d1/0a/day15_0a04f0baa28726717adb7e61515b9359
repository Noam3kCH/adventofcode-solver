d29a51861705e96ab96a13b4f3bac1e4
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.part1 = part1;
exports.part2 = part2;

const pos = ({
  x,
  y
}) => `${x},${y}`;

const count = (units, type) => units.filter(u => u.type === type).length;

function attackIfPossible(map, units, unit) {
  const inRange = u => Math.abs(u.x - unit.x) + Math.abs(u.y - unit.y) === 1;

  const attack = units.filter(u => u.type !== unit.type && inRange(u)).sort((a, b) => a.hit - b.hit || a.y - b.y || a.x - b.x).shift();

  if (attack) {
    attack.hit -= unit.attack;

    if (attack.hit <= 0) {
      units.splice(units.indexOf(attack), 1);
    }
  }

  return !!attack;
}

function neighbors(map, units, next, type, forbidden) {
  const result = [{
    x: next.x,
    y: next.y - 1
  }, {
    x: next.x - 1,
    y: next.y
  }, {
    x: next.x + 1,
    y: next.y
  }, {
    x: next.x,
    y: next.y + 1
  }].filter(p => map[p.y] && map[p.y][p.x] === '.' && !forbidden.has(pos(p))).map(p => ({ ...p,
    move: next.move || p,
    length: next.length + 1
  }));
  result.forEach(n => forbidden.add(pos(n)));
  return result;
}

function moveIfPossible(map, units, unit) {
  let solutionLength = Infinity;
  const solutions = [];
  const queue = [{
    x: unit.x,
    y: unit.y,
    length: 0
  }];
  const forbidden = new Set(units.filter(u => u.type === unit.type).map(pos));

  while (queue.length > 0 && queue[0].length <= solutionLength) {
    const next = queue.shift();

    if (units.find(u => pos(u) === pos(next) && u.type !== unit.type)) {
      solutions.push(next);
      solutionLength = next.length;
    }

    queue.push(...neighbors(map, units, next, unit.type, forbidden));
  }

  if (solutions.length > 0) {
    solutions.sort((a, b) => a.y - b.y || a.x - b.x);
    Object.assign(unit, solutions.shift().move);
  }
}

function turn(map, units) {
  units.sort((a, b) => a.y - b.y || a.x - b.x);

  for (let i = 0; i < units.length; i++) {
    if (count(units, 'E') === 0 || count(units, 'G') === 0) {
      return false;
    }

    const unit = units[i];

    if (!attackIfPossible(map, units, unit)) {
      moveIfPossible(map, units, unit);
      attackIfPossible(map, units, unit);
    }

    i = units.indexOf(unit); //in case something was removed
  }

  return true;
}

function fight(input, elfBoost = 0) {
  let i = 0;
  const units = [];
  const map = input.replace(/[EG]/g, '.').split('\n');
  input.split('\n').forEach((row, y) => row.split('').forEach((cell, x) => {
    if (cell === 'E') {
      units.push({
        type: 'E',
        hit: 200,
        attack: 3 + elfBoost,
        x,
        y
      });
    } else if (cell === 'G') {
      units.push({
        type: 'G',
        hit: 200,
        attack: 3,
        x,
        y
      });
    }
  }));

  while (turn(map, units)) {
    i++;
  }

  return {
    i,
    units
  };
}

function part1(input) {
  const {
    i,
    units
  } = fight(input);
  return i * units.reduce((sum, u) => sum += u.hit, 0);
}

function part2(input) {
  const elfCount = input.match(/E/g).length;
  let elfBoost = 1;
  let i, units;

  do {
    ({
      i,
      units
    } = fight(input, elfBoost));
    elfBoost++;
  } while (elfCount !== count(units, 'E'));

  return i * units.reduce((sum, u) => sum += u.hit, 0);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRheTE1LmpzIl0sIm5hbWVzIjpbInBvcyIsIngiLCJ5IiwiY291bnQiLCJ1bml0cyIsInR5cGUiLCJmaWx0ZXIiLCJ1IiwibGVuZ3RoIiwiYXR0YWNrSWZQb3NzaWJsZSIsIm1hcCIsInVuaXQiLCJpblJhbmdlIiwiTWF0aCIsImFicyIsImF0dGFjayIsInNvcnQiLCJhIiwiYiIsImhpdCIsInNoaWZ0Iiwic3BsaWNlIiwiaW5kZXhPZiIsIm5laWdoYm9ycyIsIm5leHQiLCJmb3JiaWRkZW4iLCJyZXN1bHQiLCJwIiwiaGFzIiwibW92ZSIsImZvckVhY2giLCJuIiwiYWRkIiwibW92ZUlmUG9zc2libGUiLCJzb2x1dGlvbkxlbmd0aCIsIkluZmluaXR5Iiwic29sdXRpb25zIiwicXVldWUiLCJTZXQiLCJmaW5kIiwicHVzaCIsIk9iamVjdCIsImFzc2lnbiIsInR1cm4iLCJpIiwiZmlnaHQiLCJpbnB1dCIsImVsZkJvb3N0IiwicmVwbGFjZSIsInNwbGl0Iiwicm93IiwiY2VsbCIsInBhcnQxIiwicmVkdWNlIiwic3VtIiwicGFydDIiLCJlbGZDb3VudCIsIm1hdGNoIl0sIm1hcHBpbmdzIjoiOzs7Ozs7OztBQUFBLE1BQU1BLEdBQUcsR0FBRyxDQUFDO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxDQUFELEtBQWUsR0FBRUQsQ0FBRSxJQUFHQyxDQUFFLEVBQXBDOztBQUNBLE1BQU1DLEtBQUssR0FBRyxDQUFDQyxLQUFELEVBQVFDLElBQVIsS0FBaUJELEtBQUssQ0FBQ0UsTUFBTixDQUFhQyxDQUFDLElBQUlBLENBQUMsQ0FBQ0YsSUFBRixLQUFXQSxJQUE3QixFQUFtQ0csTUFBbEU7O0FBRUEsU0FBU0MsZ0JBQVQsQ0FBMEJDLEdBQTFCLEVBQStCTixLQUEvQixFQUFzQ08sSUFBdEMsRUFBNEM7QUFDMUMsUUFBTUMsT0FBTyxHQUFHTCxDQUFDLElBQUlNLElBQUksQ0FBQ0MsR0FBTCxDQUFTUCxDQUFDLENBQUNOLENBQUYsR0FBTVUs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TixDQUFYLEVBQXlCO0FBQ3ZCd0MsSUFBQUEsQ0FBQztBQUNGOztBQUNELFNBQU87QUFBRUEsSUFBQUEsQ0FBRjtBQUFLeEMsSUFBQUE7QUFBTCxHQUFQO0FBQ0Q7O0FBRU0sU0FBU2dELEtBQVQsQ0FBZU4sS0FBZixFQUFzQjtBQUMzQixRQUFNO0FBQUVGLElBQUFBLENBQUY7QUFBS3hDLElBQUFBO0FBQUwsTUFBZXlDLEtBQUssQ0FBQ0MsS0FBRCxDQUExQjtBQUNBLFNBQU9GLENBQUMsR0FBR3hDLEtBQUssQ0FBQ2lELE1BQU4sQ0FBYSxDQUFDQyxHQUFELEVBQU0vQyxDQUFOLEtBQWErQyxHQUFHLElBQUkvQyxDQUFDLENBQUNZLEdBQW5DLEVBQXlDLENBQXpDLENBQVg7QUFDRDs7QUFFTSxTQUFTb0MsS0FBVCxDQUFlVCxLQUFmLEVBQXNCO0FBQzNCLFFBQU1VLFFBQVEsR0FBR1YsS0FBSyxDQUFDVyxLQUFOLENBQVksSUFBWixFQUFrQmpELE1BQW5DO0FBQ0EsTUFBSXVDLFFBQVEsR0FBRyxDQUFmO0FBQ0EsTUFBSUgsQ0FBSixFQUFPeEMsS0FBUDs7QUFDQSxLQUFHO0FBQ0QsS0FBQztBQUFFd0MsTUFBQUEsQ0FBRjtBQUFLeEMsTUFBQUE7QUFBTCxRQUFleUMsS0FBSyxDQUFDQyxLQUFELEVBQVFDLFFBQVIsQ0FBckI7QUFDQUEsSUFBQUEsUUFBUTtBQUNULEdBSEQsUUFHU1MsUUFBUSxLQUFLckQsS0FBSyxDQUFDQyxLQUFELEVBQVEsR0FBUixDQUgzQjs7QUFJQSxTQUFPd0MsQ0FBQyxHQUFHeEMsS0FBSyxDQUFDaUQsTUFBTixDQUFhLENBQUNDLEdBQUQsRUFBTS9DLENBQU4sS0FBYStDLEdBQUcsSUFBSS9DLENBQUMsQ0FBQ1ksR0FBbkMsRUFBeUMsQ0FBekMsQ0FBWDtBQUNEIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgcG9zID0gKHsgeCwgeSB9KSA9PiBgJHt4fSwke3l9YDtcbmNvbnN0IGNvdW50ID0gKHVuaXRzLCB0eXBlKSA9PiB1bml0cy5maWx0ZXIodSA9PiB1LnR5cGUgPT09IHR5cGUpLmxlbmd0aDtcblxuZnVuY3Rpb24gYXR0YWNrSWZQb3NzaWJsZShtYXAsIHVuaXRzLCB1bml0KSB7XG4gIGNvbnN0IGluUmFuZ2UgPSB1ID0+IE1hdGguYWJzKHUueCAtIHVuaXQueCkgKyBNYXRoLmFicyh1LnkgLSB1bml0LnkpID09PSAxO1xuICBjb25zdCBhdHRhY2sgPSB1bml0c1xuICAgIC5maWx0ZXIodSA9PiB1LnR5cGUgIT09IHVuaXQudHlwZSAmJiBpblJhbmdlKHUpKVxuICAgIC5zb3J0KChhLCBiKSA9PiBhLmhpdCAtIGIuaGl0IHx8IGEueSAtIGIueSB8fCBhLnggLSBiLngpXG4gICAgLnNoaWZ0KCk7XG4gIGlmIChhdHRhY2spIHtcbiAgICBhdHRhY2suaGl0IC09IHVuaXQuYXR0YWNrO1xuICAgIGlmIChhdHRhY2suaGl0IDw9IDApIHtcbiAgICAgIHVuaXRzLnNwbGljZSh1bml0cy5pbmRleE9mKGF0dGFjayksIDEpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gISFhdHRhY2s7XG59XG5cbmZ1bmN0aW9uIG5laWdoYm9ycyhtYXAsIHVuaXRzLCBuZXh0LCB0eXBlLCBmb3JiaWRkZW4pIHtcbiAgY29uc3QgcmVzdWx0ID0gW1xuICAgIHsgeDogbmV4dC54LCB5OiBuZXh0LnkgLSAxIH0sXG4gICAgeyB4OiBuZXh0LnggLSAxLCB5OiBuZXh0LnkgfSxcbiAgICB7IHg6IG5leHQueCArIDEsIHk6IG5leHQueSB9LFxuICAgIHsgeDogbmV4dC54LCB5OiBuZXh0LnkgKyAxIH0sXG4gIF1cbiAgICAuZmlsdGVyKHAgPT4gbWFwW3AueV0gJiYgbWFwW3AueV1bcC54XSA9PT0gJy4nICYmICFmb3JiaWRkZW4uaGFzKHBvcyhwKSkpXG4gICAgLm1hcChwID0+ICh7IC4uLnAsIG1vdmU6IG5leHQubW92ZSB8fCBwLCBsZW5ndGg6IG5leHQubGVuZ3RoICsgMSB9KSk7XG4gIHJlc3VsdC5mb3JFYWNoKG4gPT4gZm9yYmlkZGVuLmFkZChwb3MobikpKTtcbiAgcmV0dXJuIHJlc3VsdDtcbn1cblxuZnVuY3Rpb24gbW92ZUlmUG9zc2libGUobWFwLCB1bml0cywgdW5pdCkge1xuICBsZXQgc29sdXRpb25MZW5ndGggPSBJbmZpbml0eTtcbiAgY29uc3Qgc29sdXRpb25zID0gW107XG4gIGNvbnN0IHF1ZXVlID0gW3sgeDogdW5pdC54LCB5OiB1bml0LnksIGxlbmd0aDogMCB9XTtcbiAgY29uc3QgZm9yYmlkZGVuID0gbmV3IFNldCh1bml0cy5maWx0ZXIodSA9PiB1LnR5cGUgPT09IHVuaXQudHlwZSkubWFwKHBvcykpO1xuICB3aGlsZSAocXVldWUubGVuZ3RoID4gMCAmJiBxdWV1ZVswXS5sZW5ndGggPD0gc29sdXRpb25MZW5ndGgpIHtcbiAgICBjb25zdCBuZXh0ID0gcXVldWUuc2hpZnQoKTtcbiAgICBpZiAodW5pdHMuZmluZCh1ID0+IHBvcyh1KSA9PT0gcG9zKG5leHQpICYmIHUudHlwZSAhPT0gdW5pdC50eXBlKSkge1xuICAgICAgc29sdXRpb25zLnB1c2gobmV4dCk7XG4gICAgICBzb2x1dGlvbkxlbmd0aCA9IG5leHQubGVuZ3RoO1xuICAgIH1cbiAgICBxdWV1ZS5wdXNoKC4uLm5laWdoYm9ycyhtYXAsIHVuaXRzLCBuZXh0LCB1bml0LnR5cGUsIGZvcmJpZGRlbikpO1xuICB9XG4gIGlmIChzb2x1dGlvbnMubGVuZ3RoID4gMCkge1xuICAgIHNvbHV0aW9ucy5zb3J0KChhLCBiKSA9PiBhLnkgLSBiLnkgfHwgYS54IC0gYi54KTtcbiAgICBPYmplY3QuYXNzaWduKHVuaXQsIHNvbHV0aW9ucy5zaGlmdCgpLm1vdmUpO1xuICB9XG59XG5cbmZ1bmN0aW9uIHR1cm4obWFwLCB1bml0cykge1xuICB1bml0cy5zb3J0KChhLCBiKSA9PiBhLnkgLSBiLnkgfHwgYS54IC0gYi54KTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCB1bml0cy5sZW5ndGg7IGkrKykge1xuICAgIGlmIChjb3VudCh1bml0cywgJ0UnKSA9PT0gMCB8fCBjb3VudCh1bml0cywgJ0cnKSA9PT0gMCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBjb25zdCB1bml0ID0gdW5pdHNbaV07XG4gICAgaWYgKCFhdHRhY2tJZlBvc3NpYmxlKG1hcCwgdW5pdHMsIHVuaXQpKSB7XG4gICAgICBtb3ZlSWZQb3NzaWJsZShtYXAsIHVuaXRzLCB1bml0KTtcbiAgICAgIGF0dGFja0lmUG9zc2libGUobWFwLCB1bml0cywgdW5pdCk7XG4gICAgfVxuICAgIGkgPSB1bml0cy5pbmRleE9mKHVuaXQpOyAvL2luIGNhc2Ugc29tZXRoaW5nIHdhcyByZW1vdmVkXG4gIH1cbiAgcmV0dXJuIHRydWU7XG59XG5cbmZ1bmN0aW9uIGZpZ2h0KGlucHV0LCBlbGZCb29zdCA9IDApIHtcbiAgbGV0IGkgPSAwO1xuICBjb25zdCB1bml0cyA9IFtdO1xuICBjb25zdCBtYXAgPSBpbnB1dC5yZXBsYWNlKC9bRUddL2csICcuJykuc3BsaXQoJ1xcbicpO1xuICBpbnB1dC5zcGxpdCgnXFxuJykuZm9yRWFjaCgocm93LCB5KSA9PlxuICAgIHJvdy5zcGxpdCgnJykuZm9yRWFjaCgoY2VsbCwgeCkgPT4ge1xuICAgICAgaWYgKGNlbGwgPT09ICdFJykge1xuICAgICAgICB1bml0cy5wdXNoKHsgdHlwZTogJ0UnLCBoaXQ6IDIwMCwgYXR0YWNrOiAzICsgZWxmQm9vc3QsIHgsIHkgfSk7XG4gICAgICB9IGVsc2UgaWYgKGNlbGwgPT09ICdHJykge1xuICAgICAgICB1bml0cy5wdXNoKHsgdHlwZTogJ0cnLCBoaXQ6IDIwMCwgYXR0YWNrOiAzLCB4LCB5IH0pO1xuICAgICAgfVxuICAgIH0pLFxuICApO1xuICB3aGlsZSAodHVybihtYXAsIHVuaXRzKSkge1xuICAgIGkrKztcbiAgfVxuICByZXR1cm4geyBpLCB1bml0cyB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFydDEoaW5wdXQpIHtcbiAgY29uc3QgeyBpLCB1bml0cyB9ID0gZmlnaHQoaW5wdXQpO1xuICByZXR1cm4gaSAqIHVuaXRzLnJlZHVjZSgoc3VtLCB1KSA9PiAoc3VtICs9IHUuaGl0KSwgMCk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJ0MihpbnB1dCkge1xuICBjb25zdCBlbGZDb3VudCA9IGlucHV0Lm1hdGNoKC9FL2cpLmxlbmd0aDtcbiAgbGV0IGVsZkJvb3N0ID0gMTtcbiAgbGV0IGksIHVuaXRzO1xuICBkbyB7XG4gICAgKHsgaSwgdW5pdHMgfSA9IGZpZ2h0KGlucHV0LCBlbGZCb29zdCkpO1xuICAgIGVsZkJvb3N0Kys7XG4gIH0gd2hpbGUgKGVsZkNvdW50ICE9PSBjb3VudCh1bml0cywgJ0UnKSk7XG4gIHJldHVybiBpICogdW5pdHMucmVkdWNlKChzdW0sIHUpID0+IChzdW0gKz0gdS5oaXQpLCAwKTtcbn1cbiJdfQ==