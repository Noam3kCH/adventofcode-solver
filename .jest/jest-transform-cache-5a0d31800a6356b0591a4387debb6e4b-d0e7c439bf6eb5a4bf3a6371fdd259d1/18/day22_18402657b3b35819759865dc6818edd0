8af7e0ed8d1b96be57ef3423d38e9586
"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.part1 = part1;
exports.part2 = part2;
let cache = {};

const pos = ({
  x,
  y
}) => `${x},${y}`;

const terrain = (point, depth) => erosion(point, depth) % 3;

function erosion({
  x,
  y
}, depth) {
  let geo;
  if (cache[pos({
    x,
    y
  })] !== undefined) return cache[pos({
    x,
    y
  })];else if (y === 0) geo = x * 16807;else if (x === 0) geo = y * 48271;else geo = erosion({
    x: x - 1,
    y
  }, depth) * erosion({
    x,
    y: y - 1
  }, depth);
  cache[pos({
    x,
    y
  })] = (geo + depth) % 20183;
  return cache[pos({
    x,
    y
  })];
}

function parse(input) {
  const [depth, x, y] = input.match(/\d+/g).map(x => parseInt(x));
  return {
    depth,
    target: {
      x,
      y
    }
  };
}

function part1(input) {
  const {
    depth,
    target
  } = parse(input);
  let risk = 0;
  cache = {
    [pos(target)]: 0
  };

  for (let x = 0; x <= target.x; x++) {
    for (let y = 0; y <= target.y; y++) {
      risk += terrain({
        x,
        y
      }, depth);
    }
  }

  return risk;
}

function neighbors({
  point,
  equip,
  time
}, depth, target) {
  const options = [];
  const current = terrain(point, depth);

  const add = (p, e) => options.push({
    point: p,
    equip: e,
    time: time + (e === equip ? 1 : 8)
  });

  const points = [{
    x: point.x - 1,
    y: point.y + 0
  }, {
    x: point.x + 1,
    y: point.y + 0
  }, {
    x: point.x + 0,
    y: point.y - 1
  }, {
    x: point.x + 0,
    y: point.y + 1
  }].filter(p => p.x >= 0 && p.y >= 0);
  points.forEach(point => {
    const next = terrain(point, depth);

    if (point.x === target.x && point.y === target.y) {
      if (current !== 1 || equip === 'gear') add(point, 'torch'); //neither -> gear -> walk -> torch (7 + 1 + 7 = 15)
      else options.push({
          point,
          equip: 'torch',
          time: time + 15
        });
    } else if (next === 0) {
      if (current !== 1) add(point, 'torch');
      if (current !== 2) add(point, 'gear');
    } else if (next === 1) {
      if (current !== 0) add(point, 'neither');
      if (current !== 2) add(point, 'gear');
    } else if (next === 2) {
      if (current !== 1) add(point, 'torch');
      if (current !== 0) add(point, 'neither');
    }
  });
  return options;
}

function part2(input) {
  const {
    depth,
    target
  } = parse(input);
  const visited = new Map();
  const queue = [{
    point: {
      x: 0,
      y: 0
    },
    equip: 'torch',
    time: 0
  }];

  const score = a => a.time + Math.abs(a.point.x - target.x) + Math.abs(a.point.y - target.y);

  cache = {
    [pos(target)]: 0
  };

  while (queue.length > 0) {
    const n = queue.shift();

    if (n.point.x === target.x && n.point.y === target.y) {
      return n.time;
    }

    neighbors(n, depth, target).forEach(o => {
      const v = visited.get(`${o.point.x},${o.point.y},${o.equip}`);

      if (!v || o.time < v.time) {
        if (v) queue.splice(queue.indexOf(v), 1);
        visited.set(`${o.point.x},${o.point.y},${o.equip}`, o);
        queue.push(o);
      }
    });
    queue.sort((a, b) => score(a) - score(b));
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbImRheTIyLmpzIl0sIm5hbWVzIjpbImNhY2hlIiwicG9zIiwieCIsInkiLCJ0ZXJyYWluIiwicG9pbnQiLCJkZXB0aCIsImVyb3Npb24iLCJnZW8iLCJ1bmRlZmluZWQiLCJwYXJzZSIsImlucHV0IiwibWF0Y2giLCJtYXAiLCJwYXJzZUludCIsInRhcmdldCIsInBhcnQxIiwicmlzayIsIm5laWdoYm9ycyIsImVxdWlwIiwidGltZSIsIm9wdGlvbnMiLCJjdXJyZW50IiwiYWRkIiwicCIsImUiLCJwdXNoIiwicG9pbnRzIiwiZmlsdGVyIiwiZm9yRWFjaCIsIm5leHQiLCJwYXJ0MiIsInZpc2l0ZWQiLCJNYXAiLCJxdWV1ZSIsInNjb3JlIiwiYSIsIk1hdGgiLCJhYnMiLCJsZW5ndGgiLCJuIiwic2hpZnQiLCJvIiwidiIsImdldCIsInNwbGljZSIsImluZGV4T2YiLCJzZXQiLCJzb3J0IiwiYiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLElBQUlBLEtBQUssR0FBRyxFQUFaOztBQUNBLE1BQU1DLEdBQUcsR0FBRyxDQUFDO0FBQUVDLEVBQUFBLENBQUY7QUFBS0MsRUFBQUE7QUFBTCxDQUFELEtBQWUsR0FBRUQsQ0FBRSxJQUFHQyxDQUFFLEVBQXBDOztBQUNBLE1BQU1DLE9BQU8sR0FBRyxDQUFDQyxLQUFELEVBQVFDLEtBQVIsS0FBa0JDLE9BQU8sQ0FBQ0YsS0FBRCxFQUFRQyxLQUFSLENBQVAsR0FBd0IsQ0FBMUQ7O0FBRUEsU0FBU0MsT0FBVCxDQUFpQjtBQUFFTCxFQUFBQSxDQUFGO0FBQUtDLEVBQUFBO0FBQUwsQ0FBakIsRUFBMkJHLEtBQTNCLEVBQWtDO0FBQ2hDLE1BQUlFLEdBQUo7QUFDQSxNQUFJUixLQUFLLENBQUNDLEdBQUcsQ0FBQztBQUFFQyxJQUFBQSxDQUFGO0FBQUtDLElBQUFBO0FBQUwsR0FBRCxDQUFKLENBQUwsS0FBeUJNLFNBQTdCLEVBQXdDLE9BQU9ULEtBQUssQ0FBQ0MsR0FBRyxDQUFDO0FBQUVDLElBQUFBLENBQUY7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Q0FBQ3ZCLElBQXJCLEVBQTJCO0FBQ3pCLFlBQUl1QixDQUFKLEVBQU9ULEtBQUssQ0FBQ1csTUFBTixDQUFhWCxLQUFLLENBQUNZLE9BQU4sQ0FBY0gsQ0FBZCxDQUFiLEVBQStCLENBQS9CO0FBQ1BYLFFBQUFBLE9BQU8sQ0FBQ2UsR0FBUixDQUFhLEdBQUVMLENBQUMsQ0FBQ3JDLEtBQUYsQ0FBUUgsQ0FBRSxJQUFHd0MsQ0FBQyxDQUFDckMsS0FBRixDQUFRRixDQUFFLElBQUd1QyxDQUFDLENBQUN2QixLQUFNLEVBQWpELEVBQW9EdUIsQ0FBcEQ7QUFDQVIsUUFBQUEsS0FBSyxDQUFDUixJQUFOLENBQVdnQixDQUFYO0FBQ0Q7QUFDRixLQVBEO0FBUUFSLElBQUFBLEtBQUssQ0FBQ2MsSUFBTixDQUFXLENBQUNaLENBQUQsRUFBSWEsQ0FBSixLQUFVZCxLQUFLLENBQUNDLENBQUQsQ0FBTCxHQUFXRCxLQUFLLENBQUNjLENBQUQsQ0FBckM7QUFDRDtBQUNGIiwic291cmNlc0NvbnRlbnQiOlsibGV0IGNhY2hlID0ge307XG5jb25zdCBwb3MgPSAoeyB4LCB5IH0pID0+IGAke3h9LCR7eX1gO1xuY29uc3QgdGVycmFpbiA9IChwb2ludCwgZGVwdGgpID0+IGVyb3Npb24ocG9pbnQsIGRlcHRoKSAlIDM7XG5cbmZ1bmN0aW9uIGVyb3Npb24oeyB4LCB5IH0sIGRlcHRoKSB7XG4gIGxldCBnZW87XG4gIGlmIChjYWNoZVtwb3MoeyB4LCB5IH0pXSAhPT0gdW5kZWZpbmVkKSByZXR1cm4gY2FjaGVbcG9zKHsgeCwgeSB9KV07XG4gIGVsc2UgaWYgKHkgPT09IDApIGdlbyA9IHggKiAxNjgwNztcbiAgZWxzZSBpZiAoeCA9PT0gMCkgZ2VvID0geSAqIDQ4MjcxO1xuICBlbHNlIGdlbyA9IGVyb3Npb24oeyB4OiB4IC0gMSwgeSB9LCBkZXB0aCkgKiBlcm9zaW9uKHsgeCwgeTogeSAtIDEgfSwgZGVwdGgpO1xuICBjYWNoZVtwb3MoeyB4LCB5IH0pXSA9IChnZW8gKyBkZXB0aCkgJSAyMDE4MztcbiAgcmV0dXJuIGNhY2hlW3Bvcyh7IHgsIHkgfSldO1xufVxuXG5mdW5jdGlvbiBwYXJzZShpbnB1dCkge1xuICBjb25zdCBbZGVwdGgsIHgsIHldID0gaW5wdXQubWF0Y2goL1xcZCsvZykubWFwKHggPT4gcGFyc2VJbnQoeCkpO1xuICByZXR1cm4geyBkZXB0aCwgdGFyZ2V0OiB7IHgsIHkgfSB9O1xufVxuXG5leHBvcnQgZnVuY3Rpb24gcGFydDEoaW5wdXQpIHtcbiAgY29uc3QgeyBkZXB0aCwgdGFyZ2V0IH0gPSBwYXJzZShpbnB1dCk7XG4gIGxldCByaXNrID0gMDtcbiAgY2FjaGUgPSB7IFtwb3ModGFyZ2V0KV06IDAgfTtcbiAgZm9yIChsZXQgeCA9IDA7IHggPD0gdGFyZ2V0Lng7IHgrKykge1xuICAgIGZvciAobGV0IHkgPSAwOyB5IDw9IHRhcmdldC55OyB5KyspIHtcbiAgICAgIHJpc2sgKz0gdGVycmFpbih7IHgsIHkgfSwgZGVwdGgpO1xuICAgIH1cbiAgfVxuICByZXR1cm4gcmlzaztcbn1cblxuZnVuY3Rpb24gbmVpZ2hib3JzKHsgcG9pbnQsIGVxdWlwLCB0aW1lIH0sIGRlcHRoLCB0YXJnZXQpIHtcbiAgY29uc3Qgb3B0aW9ucyA9IFtdO1xuICBjb25zdCBjdXJyZW50ID0gdGVycmFpbihwb2ludCwgZGVwdGgpO1xuICBjb25zdCBhZGQgPSAocCwgZSkgPT5cbiAgICBvcHRpb25zLnB1c2goeyBwb2ludDogcCwgZXF1aXA6IGUsIHRpbWU6IHRpbWUgKyAoZSA9PT0gZXF1aXAgPyAxIDogOCkgfSk7XG4gIGNvbnN0IHBvaW50cyA9IFtcbiAgICB7IHg6IHBvaW50LnggLSAxLCB5OiBwb2ludC55ICsgMCB9LFxuICAgIHsgeDogcG9pbnQueCArIDEsIHk6IHBvaW50LnkgKyAwIH0sXG4gICAgeyB4OiBwb2ludC54ICsgMCwgeTogcG9pbnQueSAtIDEgfSxcbiAgICB7IHg6IHBvaW50LnggKyAwLCB5OiBwb2ludC55ICsgMSB9LFxuICBdLmZpbHRlcihwID0+IHAueCA+PSAwICYmIHAueSA+PSAwKTtcbiAgcG9pbnRzLmZvckVhY2gocG9pbnQgPT4ge1xuICAgIGNvbnN0IG5leHQgPSB0ZXJyYWluKHBvaW50LCBkZXB0aCk7XG4gICAgaWYgKHBvaW50LnggPT09IHRhcmdldC54ICYmIHBvaW50LnkgPT09IHRhcmdldC55KSB7XG4gICAgICBpZiAoY3VycmVudCAhPT0gMSB8fCBlcXVpcCA9PT0gJ2dlYXInKSBhZGQocG9pbnQsICd0b3JjaCcpO1xuICAgICAgLy9uZWl0aGVyIC0+IGdlYXIgLT4gd2FsayAtPiB0b3JjaCAoNyArIDEgKyA3ID0gMTUpXG4gICAgICBlbHNlIG9wdGlvbnMucHVzaCh7IHBvaW50LCBlcXVpcDogJ3RvcmNoJywgdGltZTogdGltZSArIDE1IH0pO1xuICAgIH0gZWxzZSBpZiAobmV4dCA9PT0gMCkge1xuICAgICAgaWYgKGN1cnJlbnQgIT09IDEpIGFkZChwb2ludCwgJ3RvcmNoJyk7XG4gICAgICBpZiAoY3VycmVudCAhPT0gMikgYWRkKHBvaW50LCAnZ2VhcicpO1xuICAgIH0gZWxzZSBpZiAobmV4dCA9PT0gMSkge1xuICAgICAgaWYgKGN1cnJlbnQgIT09IDApIGFkZChwb2ludCwgJ25laXRoZXInKTtcbiAgICAgIGlmIChjdXJyZW50ICE9PSAyKSBhZGQocG9pbnQsICdnZWFyJyk7XG4gICAgfSBlbHNlIGlmIChuZXh0ID09PSAyKSB7XG4gICAgICBpZiAoY3VycmVudCAhPT0gMSkgYWRkKHBvaW50LCAndG9yY2gnKTtcbiAgICAgIGlmIChjdXJyZW50ICE9PSAwKSBhZGQocG9pbnQsICduZWl0aGVyJyk7XG4gICAgfVxuICB9KTtcbiAgcmV0dXJuIG9wdGlvbnM7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBwYXJ0MihpbnB1dCkge1xuICBjb25zdCB7IGRlcHRoLCB0YXJnZXQgfSA9IHBhcnNlKGlucHV0KTtcbiAgY29uc3QgdmlzaXRlZCA9IG5ldyBNYXAoKTtcbiAgY29uc3QgcXVldWUgPSBbeyBwb2ludDogeyB4OiAwLCB5OiAwIH0sIGVxdWlwOiAndG9yY2gnLCB0aW1lOiAwIH1dO1xuICBjb25zdCBzY29yZSA9IGEgPT5cbiAgICBhLnRpbWUgKyBNYXRoLmFicyhhLnBvaW50LnggLSB0YXJnZXQueCkgKyBNYXRoLmFicyhhLnBvaW50LnkgLSB0YXJnZXQueSk7XG4gIGNhY2hlID0geyBbcG9zKHRhcmdldCldOiAwIH07XG4gIHdoaWxlIChxdWV1ZS5sZW5ndGggPiAwKSB7XG4gICAgY29uc3QgbiA9IHF1ZXVlLnNoaWZ0KCk7XG4gICAgaWYgKG4ucG9pbnQueCA9PT0gdGFyZ2V0LnggJiYgbi5wb2ludC55ID09PSB0YXJnZXQueSkge1xuICAgICAgcmV0dXJuIG4udGltZTtcbiAgICB9XG4gICAgbmVpZ2hib3JzKG4sIGRlcHRoLCB0YXJnZXQpLmZvckVhY2gobyA9PiB7XG4gICAgICBjb25zdCB2ID0gdmlzaXRlZC5nZXQoYCR7by5wb2ludC54fSwke28ucG9pbnQueX0sJHtvLmVxdWlwfWApO1xuICAgICAgaWYgKCF2IHx8IG8udGltZSA8IHYudGltZSkge1xuICAgICAgICBpZiAodikgcXVldWUuc3BsaWNlKHF1ZXVlLmluZGV4T2YodiksIDEpO1xuICAgICAgICB2aXNpdGVkLnNldChgJHtvLnBvaW50Lnh9LCR7by5wb2ludC55fSwke28uZXF1aXB9YCwgbyk7XG4gICAgICAgIHF1ZXVlLnB1c2gobyk7XG4gICAgICB9XG4gICAgfSk7XG4gICAgcXVldWUuc29ydCgoYSwgYikgPT4gc2NvcmUoYSkgLSBzY29yZShiKSk7XG4gIH1cbn1cbiJdfQ==